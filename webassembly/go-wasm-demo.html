<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go WebAssemblyä¸Web Workeræ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #007d9c; /* Goè¯­è¨€æ ‡å¿—è‰² */
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .info-box {
            background: #e9f7fb;
            border-left: 4px solid #00ADD8; /* Goè“è‰² */
            padding: 10px 15px;
            margin: 15px 0;
        }
        .warning-box {
            background: #fff6e6;
            border-left: 4px solid #FFD43B; /* é»„è‰²è­¦å‘Š */
            padding: 10px 15px;
            margin: 15px 0;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .controls input[type="range"] {
            flex-grow: 1;
            width: 100%;
        }
        .controls input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background: #00ADD8; /* Goè“è‰² */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #007d9c;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        button.secondary {
            background: #6d6d6d;
        }
        .result-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            min-height: 60px;
            position: relative;
        }
        .result {
            font-weight: bold;
            font-size: 1.2em;
        }
        .time {
            color: #666;
            font-style: italic;
        }
        .code {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
        }
        #animation {
            width: 50px;
            height: 50px;
            background-color: #00ADD8;
            position: relative;
            animation: moveBox 1.5s infinite alternate ease-in-out;
            margin: 20px 0;
        }
        @keyframes moveBox {
            0% { left: 0; transform: rotate(0deg); }
            100% { left: calc(100% - 50px); transform: rotate(360deg); }
        }
        .method-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .method-wasm {
            background: #00ADD8;
            color: white;
        }
        .method-js {
            background: #F7DF1E;
            color: black;
        }
        .logs {
            height: 120px;
            overflow-y: auto;
            font-family: monospace;
            background: #222;
            color: #eee;
            padding: 10px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 0.9em;
        }
        .logs .entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        .logs .time {
            color: #aaa;
        }
        .logs .info { color: #5cb85c; }
        .logs .error { color: #d9534f; }
        .logs .warn { color: #f0ad4e; }
    </style>
</head>
<body>
    <h1>Go WebAssembly ä¸ Web Worker æ¼”ç¤º</h1>
    
    <div class="card">
        <h2>ğŸ” å…³äºæ­¤æ¼”ç¤º</h2>
        <p>æœ¬æ¼”ç¤ºå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <span class="code">Go</span> è¯­è¨€ç¼–å†™ WebAssembly æ¨¡å—ï¼Œå¹¶åœ¨ Web Worker ä¸­åŠ è½½å’Œæ‰§è¡Œï¼Œä»è€Œé¿å…é˜»å¡æµè§ˆå™¨çš„ä¸»çº¿ç¨‹ã€‚</p>
        
        <div class="info-box">
            <h3>âœ… è¿è¡Œå‡†å¤‡</h3>
            <p>è¦æ­£ç¡®è¿è¡Œæ­¤æ¼”ç¤ºï¼Œéœ€è¦ä»¥ä¸‹æ–‡ä»¶ï¼š</p>
            <ol>
                <li><strong>wasm_exec.js</strong> - Goçš„WebAssemblyè¿è¡Œæ—¶æ”¯æŒæ–‡ä»¶</li>
                <li><strong>fibonacci.wasm</strong> - ç”±Goä»£ç ç¼–è¯‘çš„WebAssemblyæ¨¡å—</li>
            </ol>
            <p>ç¼–è¯‘Goä»£ç çš„å‘½ä»¤ï¼š<span class="code">GOOS=js GOARCH=wasm go build -o fibonacci.wasm fibonacci.go</span></p>
            <p>è·å–wasm_exec.jsçš„å‘½ä»¤ï¼š<span class="code">cp "$(go env GOROOT)/misc/wasm/wasm_exec.js" .</span></p>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ”„ UIå“åº”æµ‹è¯•</h2>
        <p>ä¸‹é¢çš„åŠ¨ç”»æ¡†åº”å½“ä¸€ç›´ä¿æŒå¹³æ»‘è¿åŠ¨ã€‚å¦‚æœåŠ¨ç”»å˜å¾—å¡é¡¿æˆ–è®¡æ•°å™¨åœæ­¢å¢åŠ ï¼Œè¯´æ˜ä¸»çº¿ç¨‹è¢«é˜»å¡äº†ã€‚</p>
        <div id="animation"></div>
        <div class="counter-container" style="text-align: center; margin: 10px 0;">
            <span>è®¡æ•°å™¨: </span><span id="counter" style="font-weight: bold; color: #00ADD8;">0</span>
            <span> (æ¯ç§’åº”è¯¥å¢åŠ çº¦10æ¬¡)</span>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ§® æ–æ³¢é‚£å¥‘æ•°è®¡ç®—</h2>
        
        <div class="controls">
            <label for="fibNumber">é€‰æ‹©è¦è®¡ç®—çš„æ–æ³¢é‚£å¥‘æ•°ï¼š</label>
            <input type="range" id="fibRange" min="1" max="50" value="42">
            <input type="number" id="fibNumber" min="1" max="50" value="42">
        </div>
        
        <div class="controls">
            <button id="calcMainThread">åœ¨ä¸»çº¿ç¨‹è®¡ç®—ï¼ˆä¼šé˜»å¡UIï¼‰</button>
            <button id="calcWorker">åœ¨Workerä¸­è®¡ç®—ï¼ˆä¸ä¼šé˜»å¡UIï¼‰</button>
        </div>
        
        <div class="result-box">
            <div>ç»“æœ: <span id="fibResult" class="result">-</span> <span id="methodBadge" class="method-badge"></span></div>
            <div>è®¡ç®—æ—¶é—´: <span id="calcTime" class="time">-</span></div>
        </div>
        
        <div class="warning-box">
            <p><strong>æ³¨æ„ï¼š</strong> é€‰æ‹©è¾ƒå¤§çš„æ•°å€¼(>40)åœ¨ä¸»çº¿ç¨‹è®¡ç®—æ—¶ï¼Œé¡µé¢åº”è¯¥ä¼šæ˜æ˜¾æ— å“åº”ï¼ˆåŠ¨ç”»å¡é¡¿ã€è®¡æ•°åœæ­¢ï¼‰ã€‚å¦‚æœæ²¡æœ‰æ„Ÿè§‰åˆ°é˜»å¡ï¼Œè¯·å°è¯•å¢åŠ è®¡ç®—çš„æ•°å€¼ã€‚</p>
            <p>é€’å½’è®¡ç®—æ—¶ï¼Œn=42 é€šå¸¸éœ€è¦å‡ ç§’é’Ÿï¼›n=45 å¯èƒ½éœ€è¦30ç§’ä»¥ä¸Šã€‚</p>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ“‹ çŠ¶æ€å’Œæ—¥å¿—</h2>
        <div>
            <p>WorkerçŠ¶æ€: <span id="workerStatus">æœªåˆå§‹åŒ–</span></p>
            <p>WebAssemblyçŠ¶æ€: <span id="wasmStatus">æœªåŠ è½½</span></p>
            <button id="checkStatus">æ£€æŸ¥çŠ¶æ€</button>
        </div>
        
        <div class="logs" id="logContainer">
            <!-- æ—¥å¿—å°†è¢«JavaScriptåŠ¨æ€æ·»åŠ  -->
        </div>
    </div>
    
    <!-- åŠ è½½Goçš„WebAssemblyæ”¯æŒ -->
    <script src="wasm_exec.js"></script>
    
    <script>
        // DOMå…ƒç´ å¼•ç”¨
        const fibRange = document.getElementById('fibRange');
        const fibNumber = document.getElementById('fibNumber');
        const calcMainThreadBtn = document.getElementById('calcMainThread');
        const calcWorkerBtn = document.getElementById('calcWorker');
        const fibResult = document.getElementById('fibResult');
        const calcTime = document.getElementById('calcTime');
        const methodBadge = document.getElementById('methodBadge');
        const workerStatus = document.getElementById('workerStatus');
        const wasmStatus = document.getElementById('wasmStatus');
        const checkStatusBtn = document.getElementById('checkStatus');
        const logContainer = document.getElementById('logContainer');
        
        // åŒæ­¥ä¸¤ä¸ªè¾“å…¥æ§ä»¶
        fibRange.addEventListener('input', () => {
            fibNumber.value = fibRange.value;
        });
        
        fibNumber.addEventListener('input', () => {
            fibRange.value = fibNumber.value;
        });
        
        // è®°å½•æ—¥å¿—çš„å‡½æ•°
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'entry';
            
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="time">[${time}]</span> <span class="${type}">${message}</span>`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[${type}] ${message}`);
        }
        
        // JavaScriptå®ç°çš„æ–æ³¢é‚£å¥‘å‡½æ•°(ç”¨äºä¸»çº¿ç¨‹è®¡ç®—)
        function fibonacciJs(n) {
            // é€’å½’å®ç°ï¼Œä¼šæ›´æ˜æ˜¾åœ°é˜»å¡UI
            if (n <= 1) return n;
            return fibonacciJs(n-1) + fibonacciJs(n-2);
        }
        
        // è®¾ç½®æ–¹æ³•æ ‡è®°
        function setMethodBadge(method) {
            methodBadge.textContent = method;
            methodBadge.className = 'method-badge';
            
            if (method.includes('wasm')) {
                methodBadge.classList.add('method-wasm');
                methodBadge.textContent = 'WebAssembly';
            } else {
                methodBadge.classList.add('method-js');
                methodBadge.textContent = 'JavaScript';
            }
        }
        
        // ä¸»çº¿ç¨‹è®¡ç®—æŒ‰é’®äº‹ä»¶
        calcMainThreadBtn.addEventListener('click', function() {
            const n = parseInt(fibNumber.value);
            
            log(`å¼€å§‹åœ¨ä¸»çº¿ç¨‹è®¡ç®—æ–æ³¢é‚£å¥‘(${n})...`);
            fibResult.textContent = "è®¡ç®—ä¸­...";
            calcTime.textContent = "";
            
            const start = performance.now();
            
            try {
                // è¿™ä¼šé˜»å¡UIçº¿ç¨‹
                const result = fibonacciJs(n);
                
                const end = performance.now();
                const duration = end - start;
                
                fibResult.textContent = result;
                calcTime.textContent = `${duration.toFixed(2)} ms (ä¸»çº¿ç¨‹)`;
                setMethodBadge('js');
                
                log(`ä¸»çº¿ç¨‹è®¡ç®—å®Œæˆ: Fib(${n}) = ${result}, è€—æ—¶ ${duration.toFixed(2)} ms`);
            } catch (error) {
                fibResult.textContent = "é”™è¯¯";
                calcTime.textContent = error.toString();
                log(`è®¡ç®—é”™è¯¯: ${error.toString()}`, 'error');
            }
        });
        
        // Web Worker
        let worker = null;
        
        // åˆ›å»ºWorkerå¹¶åˆå§‹åŒ–
        function setupWorker() {
            if (worker !== null) {
                log('Workerå·²å­˜åœ¨ï¼Œä¸å†åˆ›å»ºæ–°çš„Worker');
                return;
            }
            
            try {
                log('åˆ›å»ºå’Œåˆå§‹åŒ–Web Worker...');
                worker = new Worker('wasm-worker.js');
                workerStatus.textContent = 'å·²åˆ›å»º';
                
                // ç›‘å¬Workeræ¶ˆæ¯
                worker.onmessage = function(event) {
                    const data = event.data;
                    
                    switch (data.type) {
                        case 'ready':
                            log('Workerå·²å‡†å¤‡å¥½ï¼Œå‘é€åˆå§‹åŒ–å‘½ä»¤');
                            worker.postMessage({ type: 'init' });
                            break;
                            
                        case 'init':
                            log(`Workeråˆå§‹åŒ–${data.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                            wasmStatus.textContent = data.wasmLoaded ? 'å·²åŠ è½½' : 'åŠ è½½å¤±è´¥';
                            if (!data.success && data.error) {
                                log(`WebAssemblyåŠ è½½é”™è¯¯: ${data.error}`, 'error');
                            }
                            break;
                            
                        case 'result':
                            log(`Workerè®¡ç®—å®Œæˆ: Fib(${data.input}) = ${data.result}, ä½¿ç”¨${data.method}, è€—æ—¶ ${data.duration.toFixed(2)} ms`);
                            fibResult.textContent = data.result;
                            calcTime.textContent = `${data.duration.toFixed(2)} ms (Workerçº¿ç¨‹)`;
                            setMethodBadge(data.method);
                            calcWorkerBtn.disabled = false;
                            break;
                            
                        case 'error':
                            log(`Workeré”™è¯¯: ${data.message}`, 'error');
                            fibResult.textContent = "é”™è¯¯";
                            calcTime.textContent = data.message;
                            calcWorkerBtn.disabled = false;
                            break;
                            
                        case 'status':
                            workerStatus.textContent = 'è¿è¡Œä¸­';
                            wasmStatus.textContent = data.wasmLoaded ? 
                                (data.fibonacciReady ? 'å·²åŠ è½½ä¸”å¯ç”¨' : 'å·²åŠ è½½ä½†å‡½æ•°ä¸å¯ç”¨') : 
                                'æœªåŠ è½½';
                            break;
                    }
                };
                
                // å¤„ç†Workeré”™è¯¯
                worker.onerror = function(error) {
                    log(`Workeré”™è¯¯: ${error.message}`, 'error');
                    workerStatus.textContent = 'é”™è¯¯';
                    calcWorkerBtn.disabled = false;
                };
                
            } catch (error) {
                log(`åˆ›å»ºWorkerå¤±è´¥: ${error.toString()}`, 'error');
                workerStatus.textContent = 'åˆ›å»ºå¤±è´¥';
            }
        }
        
        // æ£€æŸ¥çŠ¶æ€æŒ‰é’®
        checkStatusBtn.addEventListener('click', function() {
            if (worker === null) {
                setupWorker();
            } else {
                worker.postMessage({ type: 'status' });
            }
        });
        
        // Workerè®¡ç®—æŒ‰é’®
        calcWorkerBtn.addEventListener('click', function() {
            const n = parseInt(fibNumber.value);
            
            // åˆ›å»ºWorker(å¦‚æœä¸å­˜åœ¨)
            if (worker === null) {
                setupWorker();
            }
            
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            calcWorkerBtn.disabled = true;
            
            // é‡ç½®ç»“æœæ˜¾ç¤º
            fibResult.textContent = "è®¡ç®—ä¸­...";
            calcTime.textContent = "";
            methodBadge.textContent = "";
            methodBadge.className = "method-badge";
            
            log(`å‘é€è®¡ç®—è¯·æ±‚åˆ°Worker: Fib(${n})`);
            
            // å‘é€è®¡ç®—è¯·æ±‚
            worker.postMessage({
                type: 'calculate',
                n: n
            });
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.addEventListener('load', function() {
            log('é¡µé¢å·²åŠ è½½', 'info');
            setupWorker();
            
            // æ·»åŠ è®¡æ•°å™¨ï¼Œåœ¨UIçº¿ç¨‹é˜»å¡æ—¶ä¼šåœæ­¢å¢åŠ 
            const counterElement = document.getElementById('counter');
            let count = 0;
            
            function updateCounter() {
                count++;
                counterElement.textContent = count;
                setTimeout(updateCounter, 100); // çº¦æ¯0.1ç§’æ›´æ–°ä¸€æ¬¡
            }
            
            updateCounter();
        });
    </script>
</body>
</html> 